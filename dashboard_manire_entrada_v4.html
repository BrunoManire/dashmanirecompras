<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Manirê | Dashboard Entradas In Natura</title>
<style>
  :root {
    --bg:#0b0f14; --card:#111826; --text:#e7eef7; --muted:#9db0c5; --line:#223044;
    --good:#26a269; --bad:#e01b24; --warn:#f5c211;
  }
  body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
  header { padding:18px 20px; border-bottom:1px solid var(--line); display:flex; gap:14px; align-items:flex-end; flex-wrap:wrap; }
  header h1 { font-size:18px; margin:0; }
  .muted { color:var(--muted); }
  .small { font-size:11px; }
  .controls { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
  input[type="text"] { width:min(900px, 92vw); padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0f1520; color:var(--text); }
  .datebox { display:flex; flex-direction:column; gap:4px; }
  .datebox input[type="date"] { padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0f1520; color:var(--text); }
  button { padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#182234; color:var(--text); cursor:pointer; }
  button:hover { filter:brightness(1.08); }
  main { padding:18px 20px 28px; }
  .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }
  .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; }
  .span-3 { grid-column: span 3; } .span-4 { grid-column: span 4; } .span-5 { grid-column: span 5; } .span-6 { grid-column: span 6; } .span-7 { grid-column: span 7; } .span-8 { grid-column: span 8; } .span-12 { grid-column: span 12; }
  @media (max-width: 1100px) {
    .span-3,.span-4,.span-5,.span-6,.span-7,.span-8 { grid-column: span 12; }
    input[type="text"]{ width:min(100%, 92vw); }
  }
  .kpi { display:flex; justify-content:space-between; gap:10px; align-items:baseline; }
  .kpi .val { font-size:22px; font-weight:700; }
  .kpi .lbl { color:var(--muted); font-size:12px; }
  .tag { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted); white-space:nowrap; }
  table { width:100%; border-collapse:collapse; font-size:12px; }
  th, td { padding:8px 8px; border-bottom:1px solid var(--line); vertical-align:top; }
  th { text-align:left; color:var(--muted); font-weight:600; }
  .num { text-align:right; font-variant-numeric: tabular-nums; }
  .pos { color:var(--good); } .neg { color:var(--bad); }
</style>
</head>
<body>
<header>
  <div style="flex:1 1 auto;">
    <h1>Dashboard — Entradas In Natura (Manirê)</h1>
    <div class="muted small" id="meta">Carregue o CSV publicado do Google Sheets (output=csv). Depois filtre por período.</div>
  </div>

  <div class="controls">
    <input id="csvUrl" type="text"
      value="https://docs.google.com/spreadsheets/d/e/2PACX-1vTr68Lpc3SFv05Wn28gQ3iBCk0jmRdRrWVGM49AE-3bVYR4poLY30Jxfaht2JDgUE5zyNx8vl55nAG2/pub?gid=625178800&single=true&output=csv" />

    <label class="datebox small muted">
      Data inicial
      <input id="dateStart" type="date" />
    </label>

    <label class="datebox small muted">
      Data final
      <input id="dateEnd" type="date" />
    </label>

    <button type="button" onclick="applyDateFilter()">Aplicar período</button>
    <button type="button" onclick="loadData()">Atualizar</button>
  </div>
</header>

<main>
  <div class="grid">
    <div class="card span-3">
      <div class="kpi">
        <div>
          <div class="lbl">Linhas (período)</div>
          <div class="val" id="kpi_rows">—</div>
        </div>
        <span class="tag" id="kpi_lastdate">—</span>
      </div>
    </div>

    <div class="card span-3">
      <div class="kpi">
        <div>
          <div class="lbl">Produtos distintos</div>
          <div class="val" id="kpi_prod">—</div>
        </div>
        <span class="tag" id="kpi_range">—</span>
      </div>
    </div>

    <div class="card span-3">
      <div class="kpi">
        <div>
          <div class="lbl">R$ total (janela 60d)</div>
          <div class="val" id="kpi_rtotal">—</div>
        </div>
        <span class="tag" id="kpi_prevdate">—</span>
      </div>
    </div>

    <div class="card span-3">
      <div class="kpi">
        <div>
          <div class="lbl">Kilos recebidos (janela 60d)</div>
          <div class="val" id="kpi_kilo">—</div>
        </div>
        <span class="tag" id="kpi_missing">—</span>
      </div>
    </div>

    <div class="card span-6">
      <h3 style="margin:0 0 8px 0;">Maiores desvios de preço — média vs último preço/kg</h3>
      <div class="muted small" style="margin-bottom:10px;">
        Regra: desvio% = (último R$/kg ÷ média R$/kg) − 1 (considera apenas R$/kg &gt; 0; janela 60 dias).
      </div>
      <div id="tbl_price"></div>
    </div>

    <div class="card span-6">
      <h3 style="margin:0 0 8px 0;">Maior desvio — NEC KGs (Bruno) vs KILO recebido</h3>
      <div class="muted small" style="margin-bottom:10px;">
        Regra: desvio% = (KILO − NEC) ÷ NEC (considera NEC &gt; 0 e KILO preenchido; janela 60 dias).
      </div>
      <div id="tbl_kgdev"></div>
    </div>

    <div class="card span-7">
      <h3 style="margin:0 0 8px 0;">Dia anterior disponível — desvios &ge; 30% (preço/kg)</h3>
      <div class="muted small" style="margin-bottom:10px;">
        O dashboard usa a última data do período selecionado e busca a data imediatamente anterior com registros (dentro do período).
      </div>
      <div id="tbl_prevday"></div>
    </div>

    <div class="card span-5">
      <h3 style="margin:0 0 8px 0;">Curva ABC por KILO</h3>
      <div class="muted small" style="margin-bottom:10px;">
        Base: soma de KILO (janela 60 dias). A: até 80% acumulado, B: até 95%, C: restante.
      </div>
      <div id="tbl_abc"></div>
    </div>

    <div class="card span-12">
      <h3 style="margin:0 0 8px 0;">Pendências de NF REC. (QLD. ≠ Atual/NRC/Rec.)</h3>
      <div class="muted small" style="margin-bottom:10px;">
        Critério: NF REC. vazio e QLD. diferente de Atual, NRC, Rec. (linhas com QLD vazio não entram).
      </div>
      <div id="tbl_nf"></div>
    </div>
  </div>
</main>

<script>
/* =========================
   Utils
========================= */
let ALL_DATA = [];
let MIN_DATE = null;
let MAX_DATE = null;

function parseCSV(text) {
  const rows = [];
  let row = [];
  let cell = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (c === '"') {
      if (inQuotes && text[i+1] === '"') { cell += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if (c === ',' && !inQuotes) {
      row.push(cell);
      cell = "";
    } else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (c === '\r' && text[i+1] === '\n') i++;
      row.push(cell);
      cell = "";
      if (row.some(x => x.trim() !== "")) rows.push(row);
      row = [];
    } else {
      cell += c;
    }
  }
  row.push(cell);
  if (row.some(x => (x||"").trim() !== "")) rows.push(row);
  return rows;
}

function fmtBRL(x) {
  if (x == null || !isFinite(x)) return "—";
  return x.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}
function fmtNum(x, d=2) {
  if (x == null || !isFinite(x)) return "—";
  return x.toLocaleString("pt-BR", { maximumFractionDigits: d });
}
function fmtPctHTML(x, d=1) {
  if (x == null || !isFinite(x)) return "—";
  const v = x*100;
  const s = v.toFixed(d) + "%";
  return `<span class="${x>=0?'pos':'neg'}">${s}</span>`;
}

function toNum(v) {
  if (v == null) return null;
  const s = String(v).trim();
  if (!s) return null;
  const clean = s
    .replace(/\s/g,'')
    .replace('R$','')
    .replace(/\./g,'')
    .replace(',', '.')
    .replace(/[^\d.-]/g,'');
  const n = Number(clean);
  return isFinite(n) ? n : null;
}

function toDate(v) {
  if (!v) return null;
  const s = String(v).trim();
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m) return new Date(Number(m[3]), Number(m[2])-1, Number(m[1]));
  const d = new Date(s);
  return isNaN(d) ? null : new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

function toISO(date) {
  return date.toISOString().slice(0,10);
}

function buildTable(headers, rows, max=25) {
  const safe = rows.slice(0, max);
  let h = "<table><thead><tr>";
  for (const x of headers) h += `<th>${x}</th>`;
  h += "</tr></thead><tbody>";
  for (const r of safe) {
    h += "<tr>";
    for (const c of r) h += `<td>${c}</td>`;
    h += "</tr>";
  }
  h += "</tbody></table>";
  return h;
}

/* =========================
   Date filter helpers
========================= */
function setDateInputsFromData(data) {
  const ds = data.map(x=>x.data).filter(Boolean).sort((a,b)=>a-b);
  if (!ds.length) return;

  MIN_DATE = ds[0];
  MAX_DATE = ds[ds.length-1];

  const startEl = document.getElementById("dateStart");
  const endEl = document.getElementById("dateEnd");

  startEl.min = toISO(MIN_DATE);
  startEl.max = toISO(MAX_DATE);
  endEl.min = toISO(MIN_DATE);
  endEl.max = toISO(MAX_DATE);

  if (!startEl.value) startEl.value = toISO(MIN_DATE);
  if (!endEl.value) endEl.value = toISO(MAX_DATE);

  document.getElementById("kpi_range").textContent =
    `${new Date(startEl.value).toLocaleDateString("pt-BR")} → ${new Date(endEl.value).toLocaleDateString("pt-BR")}`;
}

function getSelectedDateRange() {
  const startEl = document.getElementById("dateStart");
  const endEl = document.getElementById("dateEnd");
  const s = startEl.value ? new Date(startEl.value + "T00:00:00") : null;
  const e = endEl.value ? new Date(endEl.value + "T23:59:59") : null;
  return { s, e };
}

function filterBySelectedDates(data) {
  const { s, e } = getSelectedDateRange();
  if (!s || !e) return data;
  return data.filter(x => x.data && x.data >= s && x.data <= e);
}

function applyDateFilter() {
  if (!ALL_DATA.length) {
    alert("Carregue o CSV primeiro (Atualizar).");
    return;
  }
  document.getElementById("kpi_range").textContent =
    `${new Date(document.getElementById("dateStart").value).toLocaleDateString("pt-BR")} → ${new Date(document.getElementById("dateEnd").value).toLocaleDateString("pt-BR")}`;
  const filtered = filterBySelectedDates(ALL_DATA);
  renderDashboard(filtered);
}

/* =========================
   Load data (CSV fetch)
========================= */
async function loadData() {
  const url = document.getElementById("csvUrl").value.trim();
  if (!url) { alert("Cole a URL CSV publicada (output=csv)."); return; }

  document.getElementById("meta").textContent = "Carregando CSV...";
  ["tbl_price","tbl_kgdev","tbl_prevday","tbl_abc","tbl_nf"].forEach(id => document.getElementById(id).innerHTML = "");
  document.getElementById("kpi_rows").textContent = "—";
  document.getElementById("kpi_prod").textContent = "—";
  document.getElementById("kpi_rtotal").textContent = "—";
  document.getElementById("kpi_kilo").textContent = "—";
  document.getElementById("kpi_lastdate").textContent = "—";
  document.getElementById("kpi_prevdate").textContent = "—";
  document.getElementById("kpi_missing").textContent = "—";

  let raw;
  try {
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error("HTTP " + r.status);
    const text = await r.text();
    raw = parseCSV(text);
  } catch (err) {
    console.error(err);
    document.getElementById("meta").textContent = "Falha ao carregar CSV. Verifique se a URL termina com output=csv.";
    alert("Falha ao carregar CSV.\n\nConfirme que sua URL é do tipo:\n.../pub?gid=XXXX&single=true&output=csv");
    return;
  }

  if (!raw || !raw.length) {
    document.getElementById("meta").textContent = "CSV vazio.";
    return;
  }

  const header = raw[0].map(h => (h||"").trim());
  const idx = new Map(header.map((h,i)=>[h.toUpperCase(), i]));
  const col = (name) => idx.get(String(name).toUpperCase());

  // colunas esperadas
  const cData = col("DATA");
  const cProd = col("PRODUTO");
  const cForn = col("FORNECEDOR");
  const cNec  = col("NEC KGS (BRUNO)");
  const cKilo = col("KILO");
  const cRkg  = col("R$ KG");
  const cRtot = col("R$ TOTAL");
  const cNF   = col("NF REC.");
  const cQLD  = col("QLD.");

  const rows = raw.slice(1).filter(r => r.some(x => (x||"").trim() !== ""));
  const data = rows.map(r => {
    const d = cData!=null ? toDate(r[cData]) : null;
    const prod = cProd!=null ? String(r[cProd]||"").trim() : "";
    return {
      data: d,
      dataISO: d ? d.toISOString().slice(0,10) : null,
      produto: prod,
      fornecedor: cForn!=null ? String(r[cForn]||"").trim() : "",
      nec: cNec!=null ? toNum(r[cNec]) : null,
      kilo: cKilo!=null ? toNum(r[cKilo]) : null,
      rkg: cRkg!=null ? toNum(r[cRkg]) : null,
      rtot: cRtot!=null ? toNum(r[cRtot]) : null,
      nf: cNF!=null ? String(r[cNF]||"").trim() : "",
      qld: cQLD!=null ? String(r[cQLD]||"").trim() : ""
    };
  }).filter(x => x.produto && x.data);

  ALL_DATA = data;

  // inicializa datas automaticamente com base no CSV
  setDateInputsFromData(ALL_DATA);

  // render com período selecionado
  const filtered = filterBySelectedDates(ALL_DATA);
  renderDashboard(filtered);
}

/* =========================
   Render dashboard
========================= */
function renderDashboard(dataFiltered) {
  // datas do período selecionado
  const datesSel = dataFiltered.map(x=>x.data).filter(Boolean).sort((a,b)=>a-b);
  const selMin = datesSel.length ? datesSel[0] : null;
  const selMax = datesSel.length ? datesSel[datesSel.length-1] : null;

  // janela 60d baseada na última data DO PERÍODO selecionado
  const maxDate = selMax || new Date();
  const winStart = new Date(maxDate.getTime() - 60*24*3600*1000);
  const inWin = dataFiltered.filter(x => x.data && x.data >= winStart && x.data <= maxDate);

  // KPIs baseados no período selecionado (linhas/produtos) e janela 60d (R$ e KILO)
  const linhas = dataFiltered.length;
  const produtos = new Set(dataFiltered.map(x=>x.produto)).size;
  const rTotal60 = inWin.map(x=>x.rtot).filter(x=>x!=null).reduce((s,v)=>s+v,0);
  const kilos60 = inWin.map(x=>x.kilo).filter(x=>x!=null).reduce((s,v)=>s+v,0);

  const kiloMissing = inWin.length ? (inWin.filter(x=>x.kilo==null).length / inWin.length) : 0;

  document.getElementById("kpi_rows").textContent = fmtNum(linhas,0);
  document.getElementById("kpi_prod").textContent = fmtNum(produtos,0);
  document.getElementById("kpi_rtotal").textContent = rTotal60 ? fmtBRL(rTotal60) : "—";
  document.getElementById("kpi_kilo").textContent = kilos60 ? fmtNum(kilos60,0) : "—";

  document.getElementById("kpi_lastdate").textContent = selMax ? `até ${selMax.toLocaleDateString("pt-BR")}` : "—";
  document.getElementById("kpi_missing").textContent = inWin.length ? `KILO ausente: ${(kiloMissing*100).toFixed(1)}%` : "—";

  // 1) Desvios de preço (R$/kg) — média vs último
  const byProd = new Map();
  for (const r of inWin) {
    if (r.rkg == null || r.rkg <= 0) continue;
    if (!byProd.has(r.produto)) byProd.set(r.produto, []);
    byProd.get(r.produto).push(r);
  }

  const priceDev = [];
  for (const [p, arr] of byProd.entries()) {
    arr.sort((a,b)=> (a.data?.getTime()||0)-(b.data?.getTime()||0));
    const avg = arr.map(x=>x.rkg).reduce((s,v)=>s+v,0)/arr.length;
    const last = arr[arr.length-1];
    const dev = avg ? (last.rkg/avg)-1 : null;
    priceDev.push({produto:p, avg, last:last.rkg, date:last.dataISO, dev, abs: dev==null?null:Math.abs(dev)});
  }
  priceDev.sort((a,b)=>(b.abs||-1)-(a.abs||-1));

  document.getElementById("tbl_price").innerHTML = priceDev.length ? buildTable(
    ["Produto","Média R$/kg (60d)","Último R$/kg","Desvio","Última data"],
    priceDev.slice(0,25).map(x=>[
      x.produto,
      fmtBRL(x.avg),
      fmtBRL(x.last),
      fmtPctHTML(x.dev),
      x.date||""
    ]),
    25
  ) : "<div class='muted small'>Sem dados suficientes de R$ KG na janela de 60 dias.</div>";

  // 2) Desvio NEC vs KILO
  const kgdev = [];
  for (const r of inWin) {
    if (r.nec==null || r.nec===0 || r.kilo==null) continue;
    const dev = (r.kilo - r.nec)/r.nec;
    kgdev.push({...r, dev, abs: Math.abs(dev)});
  }
  kgdev.sort((a,b)=>b.abs-a.abs);

  document.getElementById("tbl_kgdev").innerHTML = kgdev.length ? buildTable(
    ["Data","Produto","Fornecedor","NEC","KILO","Desvio"],
    kgdev.slice(0,25).map(x=>[
      x.dataISO||"",
      x.produto,
      x.fornecedor,
      fmtNum(x.nec,2),
      fmtNum(x.kilo,2),
      fmtPctHTML(x.dev)
    ]),
    25
  ) : "<div class='muted small'>Sem dados suficientes (NEC e KILO) na janela de 60 dias.</div>";

  // 3) Dia anterior disponível — desvios >= 30% (preço/kg)
  const uniqueDates = Array.from(new Set(inWin.map(x=>x.dataISO).filter(Boolean))).sort();
  const yday = uniqueDates.length>1 ? uniqueDates[uniqueDates.length-2] : null;
  document.getElementById("kpi_prevdate").textContent = yday ? `dia ant.: ${new Date(yday).toLocaleDateString("pt-BR")}` : "dia ant.: —";

  let yRows = [];
  if (yday && priceDev.length) {
    const avgByProd = new Map(priceDev.map(x=>[x.produto, x.avg]));
    yRows = inWin
      .filter(x=>x.dataISO===yday && x.rkg!=null && x.rkg>0 && avgByProd.get(x.produto))
      .map(x=>{
        const avg=avgByProd.get(x.produto);
        const dev=(x.rkg/avg)-1;
        return {...x, avg, dev, abs: Math.abs(dev)};
      })
      .filter(x=>x.abs>=0.30)
      .sort((a,b)=>b.abs-a.abs);
  }

  document.getElementById("tbl_prevday").innerHTML = yday ? (
    yRows.length ? buildTable(
      ["Dia","Produto","Fornecedor","R$/kg","Média 60d","Desvio"],
      yRows.slice(0,25).map(x=>[
        yday,
        x.produto,
        x.fornecedor,
        fmtBRL(x.rkg),
        fmtBRL(x.avg),
        fmtPctHTML(x.dev)
      ]),
      25
    ) : "<div class='muted small'>Nenhum item com desvio ≥ 30% (preço/kg) no “dia anterior” dentro da janela.</div>"
  ) : "<div class='muted small'>Sem histórico suficiente para identificar “dia anterior”.</div>";

  // 4) Curva ABC por KILO (60d)
  const kiloByProd = new Map();
  for (const r of inWin) {
    if (r.kilo==null) continue;
    kiloByProd.set(r.produto, (kiloByProd.get(r.produto)||0)+r.kilo);
  }
  const abc = Array.from(kiloByProd.entries()).map(([produto,kilo])=>({produto,kilo}));
  abc.sort((a,b)=>b.kilo-a.kilo);

  const totalK = abc.reduce((s,x)=>s+x.kilo,0) || 1;
  let acc=0;
  const abcRows = abc.map(x=>{
    acc += x.kilo;
    const accPct = acc/totalK;
    const cls = accPct<=0.8 ? "A" : (accPct<=0.95 ? "B" : "C");
    return {...x, accPct, cls};
  });

  document.getElementById("tbl_abc").innerHTML = abcRows.length ? buildTable(
    ["Produto","KILO (60d)","% acum.","Classe"],
    abcRows.slice(0,25).map(x=>[
      x.produto,
      fmtNum(x.kilo,0),
      fmtPctHTML(x.accPct,1),
      x.cls
    ]),
    25
  ) : "<div class='muted small'>Sem KILO suficiente na janela de 60 dias.</div>";

  // 5) Pendências NF REC
  const bad = new Set(["ATUAL","NRC","REC.","REC"]);
  const pend = inWin.filter(x=>{
    const q = (x.qld||"").trim().toUpperCase();
    return (!x.nf) && q && !bad.has(q);
  });

  document.getElementById("tbl_nf").innerHTML = pend.length ? buildTable(
    ["Data","Produto","Fornecedor","QLD.","NF REC."],
    pend.slice(0,25).map(x=>[
      x.dataISO||"",
      x.produto,
      x.fornecedor,
      x.qld||"",
      x.nf||""
    ]),
    25
  ) : "<div class='muted small'>Sem pendências de NF REC (com QLD válido) na janela de 60 dias.</div>";

  const rangeTxt = selMin && selMax
    ? `Período: ${selMin.toLocaleDateString("pt-BR")} → ${selMax.toLocaleDateString("pt-BR")}`
    : "Período: —";

  document.getElementById("meta").textContent =
    `OK — ${fmtNum(linhas,0)} linhas (período selecionado). ${rangeTxt}. ` +
    `Janela 60d: ${winStart.toLocaleDateString("pt-BR")} → ${maxDate.toLocaleDateString("pt-BR")}.`;
}

// Carrega automaticamente na abertura (opcional). Se preferir manual, comente a linha abaixo.
// loadData();
</script>
</body>
</html>
