<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Manirê | Dashboard Entradas In Natura</title>
<style>
  :root{
    --bg:#0b0f14; --card:#111826; --text:#e7eef7; --muted:#9db0c5; --line:#223044;
    --good:#26a269; --bad:#e01b24; --warn:#f5c211;
  }
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
  header{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:flex-end;flex-wrap:wrap;}
  header h1{font-size:18px;margin:0;}
  .muted{color:var(--muted);}
  .small{font-size:11px;}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;}
  input[type="text"]{width:min(900px,92vw);padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f1520;color:var(--text);}
  .datebox{display:flex;flex-direction:column;gap:4px;}
  .datebox input[type="date"]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f1520;color:var(--text);}
  button{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#182234;color:var(--text);cursor:pointer;}
  button:hover{filter:brightness(1.08);}
  main{padding:18px 20px 28px;}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;}
  .span-3{grid-column:span 3;} .span-4{grid-column:span 4;} .span-5{grid-column:span 5;}
  .span-6{grid-column:span 6;} .span-7{grid-column:span 7;} .span-8{grid-column:span 8;} .span-12{grid-column:span 12;}
  @media (max-width:1100px){
    .span-3,.span-4,.span-5,.span-6,.span-7,.span-8{grid-column:span 12;}
    input[type="text"]{width:min(100%,92vw);}
  }
  .kpi{display:flex;justify-content:space-between;gap:10px;align-items:baseline;}
  .kpi .val{font-size:22px;font-weight:700;}
  .kpi .lbl{color:var(--muted);font-size:12px;}
  .tag{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);white-space:nowrap;}

  /* tabelas com scroll interno */
  .tablewrap{
    max-height:420px;
    overflow:auto;
    border:1px solid var(--line);
    border-radius:12px;
    background:#0f1520;
  }
  table{width:100%;border-collapse:collapse;font-size:12px;min-width:900px;}
  th,td{padding:8px 8px;border-bottom:1px solid var(--line);vertical-align:top;white-space:nowrap;}
  th{text-align:left;color:var(--muted);font-weight:600;position:sticky;top:0;background:#0f1520;z-index:1;}
  .pos{color:var(--good);} .neg{color:var(--bad);}
  .warn{color:var(--warn);font-weight:700;}
  code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}

  /* headers clicáveis para ordenação */
  th.sortable{cursor:pointer; user-select:none;}
  th.sortable:hover{filter:brightness(1.15);}
  .sort-ind{margin-left:6px;color:var(--muted);font-size:11px;}

  /* =========================
     MENU (HAMBURGUER + DRAWER)
     ========================= */
  .hambtn{
    width:40px;height:40px;border-radius:12px;
    display:grid;place-items:center;
    border:1px solid var(--line);
    background:#182234;color:var(--text);
    cursor:pointer;
  }
  .hambtn:hover{filter:brightness(1.08);}

  .drawerOverlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,.55);
    display:none;
    z-index:50;
  }
  .drawer{
    position:fixed; top:0; left:0;
    width:min(340px, 88vw);
    height:100vh;
    background:var(--card);
    border-right:1px solid var(--line);
    transform:translateX(-105%);
    transition:transform .18s ease;
    z-index:60;
    display:flex;
    flex-direction:column;
  }
  .drawer.open{transform:translateX(0);}

  .drawerHeader{
    padding:16px 16px 10px;
    border-bottom:1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .drawerTitle{font-weight:700;}

  .drawerClose{
    width:36px;height:36px;border-radius:12px;
    border:1px solid var(--line);
    background:#0f1520;color:var(--text);
    cursor:pointer;
  }
  .drawerClose:hover{filter:brightness(1.08);}

  .drawerBody{
    padding:12px 10px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .navLink{
    display:flex;
    flex-direction:column;
    gap:2px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--line);
    background:#0f1520;
    color:var(--text);
    text-decoration:none;
  }
  .navLink:hover{filter:brightness(1.08);}
  .navLink .sub{color:var(--muted); font-size:11px;}
  .navLink.active{
    outline:2px solid rgba(245,194,17,.25);
    border-color:rgba(245,194,17,.55);
  }
</style>
</head>
<body>

<header>
  <!-- Botão do menu (☰) -->
  <button class="hambtn" type="button" onclick="openDrawer()" aria-label="Abrir menu">☰</button>

  <div style="flex:1 1 auto;">
    <h1>Dashboard — Entradas In Natura (Manirê)</h1>
    <div class="muted small" id="meta">Carregue o CSV publicado do Google Sheets (output=csv). Depois filtre por período.</div>
  </div>

  <div class="controls">
    <input id="csvUrl" type="text"
      value="https://docs.google.com/spreadsheets/d/e/2PACX-1vTr68Lpc3SFv05Wn28gQ3iBCk0jmRdRrWVGM49AE-3bVYR4poLY30Jxfaht2JDgUE5zyNx8vl55nAG2/pub?gid=625178800&single=true&output=csv" />

    <label class="datebox small muted">
      Data inicial
      <input id="dateStart" type="date" />
    </label>

    <label class="datebox small muted">
      Data final
      <input id="dateEnd" type="date" />
    </label>

    <button type="button" onclick="applyDateFilter()">Aplicar período</button>
    <button type="button" onclick="loadData()">Atualizar</button>
  </div>
</header>

  <!-- OVERLAY + DRAWER (MENU LATERAL) -->
<div id="drawerOverlay" class="drawerOverlay" onclick="closeDrawer()"></div>

<aside id="drawer" class="drawer" aria-label="Menu de navegação">
  <div class="drawerHeader">
    <div class="drawerTitle">Manirê • Navegação</div>
    <button class="drawerClose" type="button" onclick="closeDrawer()" aria-label="Fechar">✕</button>
  </div>

  <nav class="drawerBody">
    <a class="navLink active" href="dashboard_manire_entrada_v4.html">
      <div>Dashboard • Entradas In Natura</div>
      <div class="sub">Preço, KILO, ABC, pendências</div>
    </a>

    <a class="navLink" href="dashboard_reuniao_semanal.html">
      <div>Reunião Semanal</div>
      <div class="sub">Nova aba de relatórios (mesmo período)</div>
    </a>
  </nav>
</aside>



<main>
  <div class="grid">

    <div class="card span-3">
      <div class="kpi">
        <div>
          <div class="lbl">Linhas (período)</div>
          <div class="val" id="kpi_rows">—</div>
        </div>
        <span class="tag" id="kpi_lastdate">—</span>
      </div>
    </div>

    <div class="card span-3">
      <div class="kpi">
        <div>
          <div class="lbl">Produtos distintos</div>
          <div class="val" id="kpi_prod">—</div>
        </div>
        <span class="tag" id="kpi_range">—</span>
      </div>
    </div>

    <div class="card span-3">
      <div class="kpi">
        <div>
          <div class="lbl">R$ total (janela 60d)</div>
          <div class="val" id="kpi_rtotal">—</div>
        </div>
        <span class="tag" id="kpi_prevdate">—</span>
      </div>
    </div>

    <div class="card span-3">
      <div class="kpi">
        <div>
          <div class="lbl">Kilos recebidos (janela 60d)</div>
          <div class="val" id="kpi_kilo">—</div>
        </div>
        <span class="tag" id="kpi_missing">—</span>
      </div>
    </div>

    <div class="card span-12">
      <div class="muted small">
        <b>DEBUG (automático):</b> <span id="dbg_cols">—</span><br/>
        <span id="dbg_lastcols">—</span>
      </div>
    </div>

    <div class="card span-6">
      <h3 style="margin:0 0 8px 0;">Maiores desvios de preço — DIF. R$ fora de ±30%</h3>
      <div class="muted small" style="margin-bottom:10px;">
        Regra: lista linhas onde <b>DIF. R$</b> ≥ +30% ou ≤ −30%, usando colunas:
        <b>PRODUTO</b>, <b>LOTE</b>, <b>DATA</b>, <b>R$.KG</b>, <b>BASE R$</b>, <b>DIF. R$</b>, <b>KILO</b>.
        Se <b>BASE R$</b> vier vazio no CSV, o painel calcula: <code>BASE = R$.KG / (1 + DIF)</code>.
        Clique nos cabeçalhos para ordenar.
      </div>
      <div class="tablewrap" id="tbl_price"></div>
    </div>

    <div class="card span-6">
      <h3 style="margin:0 0 8px 0;">Maior desvio — NEC KGs (Bruno) vs KILO recebido</h3>
      <div class="muted small" style="margin-bottom:10px;">
        Regra: desvio% = (KILO − NEC) ÷ NEC (considera NEC &gt; 0 e KILO preenchido; janela 60 dias).
        Clique nos cabeçalhos para ordenar.
      </div>
      <div class="tablewrap" id="tbl_kgdev"></div>
    </div>

    <div class="card span-7">
      <h3 style="margin:0 0 8px 0;">Dia anterior disponível — desvios ≥ 30% (DIF. R$)</h3>
      <div class="muted small" style="margin-bottom:10px;">
        O dashboard usa a última data do período selecionado e busca a data imediatamente anterior com registros (dentro do período).
        Clique nos cabeçalhos para ordenar.
      </div>
      <div class="tablewrap" id="tbl_prevday"></div>
    </div>

    <div class="card span-5">
      <h3 style="margin:0 0 8px 0;">Curva ABC por KILO</h3>
      <div class="muted small" style="margin-bottom:10px;">
        Base: soma de KILO (janela 60 dias). A: até 80% acumulado, B: até 95%, C: restante.
        Clique nos cabeçalhos para ordenar.
      </div>
      <div class="tablewrap" id="tbl_abc"></div>
    </div>

    <div class="card span-12">
      <h3 style="margin:0 0 8px 0;">Pendências de NF REC. (QLD. ≠ Atual/NRC/Rec.)</h3>
      <div class="muted small" style="margin-bottom:10px;">
        Critério: NF REC. vazio e QLD. diferente de Atual, NRC, Rec. (linhas com QLD vazio não entram).
        Clique nos cabeçalhos para ordenar.
      </div>
      <div class="tablewrap" id="tbl_nf"></div>
    </div>

  </div>
</main>

<script>
/* =========================
   Estado
========================= */

function openDrawer(){
  document.getElementById("drawerOverlay").style.display = "block";
  document.getElementById("drawer").classList.add("open");
}
function closeDrawer(){
  document.getElementById("drawerOverlay").style.display = "none";
  document.getElementById("drawer").classList.remove("open");
}

// opcional: fechar com ESC
window.addEventListener("keydown", (e)=>{
  if(e.key === "Escape") closeDrawer();
});


let ALL_DATA = [];
let MIN_DATE = null;
let MAX_DATE = null;
let RAW_HEADER = [];

/* Estado de ordenação por tabela */
const SORT_STATE = {
  price:   { key: "abs", dir: "desc" },  // default: maior desvio primeiro
  kgdev:   { key: "abs", dir: "desc" },
  prevday: { key: "abs", dir: "desc" },
  abc:     { key: "kilo", dir: "desc" },
  nf:      { key: "dataTS", dir: "desc" }
};

/* =========================
   CSV parser (simples)
========================= */
function parseCSV(text){
  const rows=[];
  let row=[], cell="", inQuotes=false;

  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(c === '"'){
      if(inQuotes && text[i+1] === '"'){ cell+='"'; i++; }
      else inQuotes = !inQuotes;
    } else if(c === ',' && !inQuotes){
      row.push(cell); cell="";
    } else if((c === '\n' || c === '\r') && !inQuotes){
      if(c === '\r' && text[i+1] === '\n') i++;
      row.push(cell); cell="";
      if(row.some(x => String(x||"").trim() !== "")) rows.push(row);
      row=[];
    } else {
      cell += c;
    }
  }
  row.push(cell);
  if(row.some(x => String(x||"").trim() !== "")) rows.push(row);
  return rows;
}

/* =========================
   Normalização de cabeçalho
========================= */
function normHeader(s){
  return String(s||"")
    .replace(/\u00A0/g," ")
    .trim()
    .replace(/\s+/g," ")
    .toUpperCase();
}
function makeIndexMap(header){
  const idx = new Map();
  header.forEach((h,i)=>{
    const key = normHeader(h);
    if(key && !idx.has(key)) idx.set(key,i);
  });
  return idx;
}
function colAny(idx, candidates){
  for(const c of candidates){
    const k = normHeader(c);
    if(idx.has(k)) return idx.get(k);
  }
  return null;
}

/* =========================
   Format
========================= */
function fmtBRL(x){
  if(x==null || !isFinite(x)) return "—";
  return x.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}
function fmtNum(x,d=2){
  if(x==null || !isFinite(x)) return "—";
  return x.toLocaleString("pt-BR",{maximumFractionDigits:d});
}
function fmtPctHTML(x,d=1){
  if(x==null || !isFinite(x)) return "—";
  const v=x*100;
  const s=v.toFixed(d)+"%";
  return `<span class="${x>=0?'pos':'neg'}">${s}</span>`;
}

/* =========================
   Parsing numérico e data
========================= */
function toNum(v){
  if(v==null) return null;
  const s=String(v).trim();
  if(!s) return null;
  const clean = s
    .replace(/\u00A0/g," ")
    .replace(/\s/g,"")
    .replace(/R\$/gi,"")
    .replace(/\./g,"")
    .replace(",",".")
    .replace(/[^\d.-]/g,"");
  const n=Number(clean);
  return isFinite(n)?n:null;
}
function toPct(v){
  if(v==null) return null;
  const s=String(v).trim();
  if(!s) return null;
  const hasPct = s.includes("%");
  let n = toNum(s);
  if(n==null) return null;
  if(hasPct || Math.abs(n)>1) n = n/100;
  return n;
}
function toDate(v){
  if(!v) return null;
  const s=String(v).trim();
  const m=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(m) return new Date(Number(m[3]),Number(m[2])-1,Number(m[1]));
  const d=new Date(s);
  return isNaN(d) ? null : new Date(d.getFullYear(),d.getMonth(),d.getDate());
}
function toISO(d){ return d.toISOString().slice(0,10); }

/* =========================
   Ordenação + tabela clicável
========================= */
function safeStr(v){ return (v==null) ? "" : String(v); }

function compare(a, b, dir){
  const mult = (dir === "asc") ? 1 : -1;

  // nulls sempre por último
  if(a == null && b == null) return 0;
  if(a == null) return 1;
  if(b == null) return -1;

  // number
  if(typeof a === "number" && typeof b === "number"){
    if(!isFinite(a) && !isFinite(b)) return 0;
    if(!isFinite(a)) return 1;
    if(!isFinite(b)) return -1;
    return (a - b) * mult;
  }

  // date timestamp
  if(typeof a === "bigint" || typeof b === "bigint"){
    const aa = BigInt(a), bb = BigInt(b);
    return (aa > bb ? 1 : aa < bb ? -1 : 0) * mult;
  }

  // string fallback
  const sa = safeStr(a).toUpperCase();
  const sb = safeStr(b).toUpperCase();
  if(sa === sb) return 0;
  return (sa > sb ? 1 : -1) * mult;
}

/**
 * Renderiza tabela com cabeçalhos clicáveis.
 * - tableId: chave do SORT_STATE ("price","kgdev","prevday","abc","nf")
 * - mountId: elemento container (div.tablewrap)
 * - cols: [{label, key, type}]  type: "text"|"num"|"pct"|"brl"|"date"
 * - rows: array de objetos já preparados (com campos numéricos para ordenar)
 * - rowToCells: (r)=> array de strings HTML para <td>
 */
function renderSortableTable(tableId, mountId, cols, rows, rowToCells){
  const state = SORT_STATE[tableId] || { key: cols[0]?.key, dir: "asc" };
  SORT_STATE[tableId] = state;

  // ordena
  const sorted = [...rows].sort((r1, r2) => compare(r1[state.key], r2[state.key], state.dir));

  // header
  let html = `<table><thead><tr>`;
  for(const c of cols){
    const active = (c.key === state.key);
    const ind = active ? (state.dir === "asc" ? "▲" : "▼") : "";
    html += `<th class="sortable" data-t="${tableId}" data-k="${c.key}">
               ${c.label}<span class="sort-ind">${ind}</span>
             </th>`;
  }
  html += `</tr></thead><tbody>`;

  for(const r of sorted){
    const tds = rowToCells(r);
    html += `<tr>${tds.map(x=>`<td>${x}</td>`).join("")}</tr>`;
  }
  html += `</tbody></table>`;

  const mount = document.getElementById(mountId);
  mount.innerHTML = html;

  // bind clicks
  mount.querySelectorAll("th.sortable").forEach(th=>{
    th.addEventListener("click", ()=>{
      const t = th.getAttribute("data-t");
      const k = th.getAttribute("data-k");
      const st = SORT_STATE[t] || { key:k, dir:"asc" };

      if(st.key === k){
        st.dir = (st.dir === "asc") ? "desc" : "asc";
      } else {
        st.key = k;
        st.dir = "asc"; // ao trocar coluna, começa asc
      }
      SORT_STATE[t] = st;

      // re-render do dashboard inteiro (mantém consistência)
      renderDashboard(filterBySelectedDates(ALL_DATA));
    });
  });
}

/* =========================
   Date filter helpers
========================= */
function setDateInputsFromData(data){
  const ds=data.map(x=>x.data).filter(Boolean).sort((a,b)=>a-b);
  if(!ds.length) return;

  MIN_DATE=ds[0]; MAX_DATE=ds[ds.length-1];

  const startEl=document.getElementById("dateStart");
  const endEl=document.getElementById("dateEnd");

  startEl.min=toISO(MIN_DATE); startEl.max=toISO(MAX_DATE);
  endEl.min=toISO(MIN_DATE);   endEl.max=toISO(MAX_DATE);

  if(!startEl.value) startEl.value=toISO(MIN_DATE);
  if(!endEl.value) endEl.value=toISO(MAX_DATE);

  document.getElementById("kpi_range").textContent =
    `${new Date(startEl.value).toLocaleDateString("pt-BR")} → ${new Date(endEl.value).toLocaleDateString("pt-BR")}`;
}
function getSelectedDateRange(){
  const s = document.getElementById("dateStart").value ? new Date(document.getElementById("dateStart").value+"T00:00:00") : null;
  const e = document.getElementById("dateEnd").value ? new Date(document.getElementById("dateEnd").value+"T23:59:59") : null;
  return {s,e};
}
function filterBySelectedDates(data){
  const {s,e}=getSelectedDateRange();
  if(!s||!e) return data;
  return data.filter(x=>x.data && x.data>=s && x.data<=e);
}
function applyDateFilter(){
  if(!ALL_DATA.length){ alert("Carregue o CSV primeiro (Atualizar)."); return; }
  document.getElementById("kpi_range").textContent =
    `${new Date(document.getElementById("dateStart").value).toLocaleDateString("pt-BR")} → ${new Date(document.getElementById("dateEnd").value).toLocaleDateString("pt-BR")}`;
  renderDashboard(filterBySelectedDates(ALL_DATA));
}

/* =========================
   Load data
========================= */
async function loadData(){
  const url=document.getElementById("csvUrl").value.trim();
  if(!url){ alert("Cole a URL CSV publicada (output=csv)."); return; }

  document.getElementById("meta").textContent="Carregando CSV...";
  ["tbl_price","tbl_kgdev","tbl_prevday","tbl_abc","tbl_nf"].forEach(id=>document.getElementById(id).innerHTML="");
  ["kpi_rows","kpi_prod","kpi_rtotal","kpi_kilo","kpi_lastdate","kpi_prevdate","kpi_missing"].forEach(id=>{
    const el=document.getElementById(id); if(el) el.textContent="—";
  });
  document.getElementById("dbg_cols").textContent="—";
  document.getElementById("dbg_lastcols").textContent="—";

  let raw;
  try{
    const r=await fetch(url,{cache:"no-store"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    raw=parseCSV(await r.text());
  }catch(err){
    console.error(err);
    document.getElementById("meta").textContent="Falha ao carregar CSV. Verifique se a URL termina com output=csv.";
    alert("Falha ao carregar CSV.\n\nConfirme que sua URL é do tipo:\n.../pub?gid=XXXX&single=true&output=csv");
    return;
  }

  if(!raw || !raw.length){
    document.getElementById("meta").textContent="CSV vazio.";
    return;
  }

  RAW_HEADER = raw[0].map(h=>String(h||"").replace(/\u00A0/g," ").trim());
  const idx = makeIndexMap(RAW_HEADER);

  // DEBUG: colunas
  document.getElementById("dbg_cols").innerHTML =
    `Colunas no CSV: <b>${RAW_HEADER.length}</b>`;
  const tail = RAW_HEADER.slice(Math.max(0, RAW_HEADER.length-12));
  document.getElementById("dbg_lastcols").innerHTML =
    `Últimas colunas: <code>${tail.join(" | ")}</code>`;

  // Nomes conforme seu print (aceitando variações)
  const cLote = colAny(idx, ["LOTE"]);
  const cData = colAny(idx, ["DATA"]);
  const cProd = colAny(idx, ["PRODUTO"]);
  const cForn = colAny(idx, ["FORNECEDOR"]);
  const cNec  = colAny(idx, ["NEC KGS (BRUNO)","KGS (BRL)"]);
  const cKilo = colAny(idx, ["KILO"]);
  const cRkg  = colAny(idx, ["R$.KG","R$ KG","R$/KG","R$KG"]);
  const cRtot = colAny(idx, ["R$.TOTAL","R$ TOTAL","R$TOTAL","R$. TOTAL"]);
  const cNF   = colAny(idx, ["NF REC.","NF REC"]);
  const cQLD  = colAny(idx, ["QLD.","QLD"]);

  // Base e Dif por NOME
  const cBase = colAny(idx, ["BASE R$","BASE R","BASE RS","BASE R$ ","BASE R$  ","BASE"]);
  const cDif  = colAny(idx, ["DIF. R$","DIF R$","DIF. RS","DIF RS","DIF. R","DIF R"]);

  const rows = raw.slice(1).filter(r => r.some(x => String(x||"").trim() !== ""));

  const data = rows.map(r=>{
    const d = cData!=null ? toDate(r[cData]) : null;
    const produto = cProd!=null ? String(r[cProd]||"").trim() : "";

    const rkg = cRkg!=null ? toNum(r[cRkg]) : null;
    const dif = cDif!=null ? toPct(r[cDif]) : null;
    let base  = cBase!=null ? toNum(r[cBase]) : null;

    // fallback: calcula BASE se veio nulo mas temos R$.KG e DIF
    if((base==null || !isFinite(base)) && rkg!=null && isFinite(rkg) && dif!=null && isFinite(dif) && (1+dif) !== 0){
      base = rkg / (1 + dif);
    }

    return {
      data:d,
      dataISO: d ? toISO(d) : null,
      dataTS: d ? d.getTime() : null,
      lote: cLote!=null ? String(r[cLote]||"").trim() : "",
      produto,
      fornecedor: cForn!=null ? String(r[cForn]||"").trim() : "",
      nec: cNec!=null ? toNum(r[cNec]) : null,
      kilo: cKilo!=null ? toNum(r[cKilo]) : null,
      rkg,
      rtot: cRtot!=null ? toNum(r[cRtot]) : null,
      base_r: base,
      dif_r_pct: dif,
      nf: cNF!=null ? String(r[cNF]||"").trim() : "",
      qld: cQLD!=null ? String(r[cQLD]||"").trim() : ""
    };
  }).filter(x=>x.produto && x.data);

  ALL_DATA=data;
  setDateInputsFromData(ALL_DATA);
  renderDashboard(filterBySelectedDates(ALL_DATA));
}

/* =========================
   Render dashboard
========================= */
function renderDashboard(dataFiltered){
  const datesSel = dataFiltered.map(x=>x.data).filter(Boolean).sort((a,b)=>a-b);
  const selMin = datesSel.length ? datesSel[0] : null;
  const selMax = datesSel.length ? datesSel[datesSel.length-1] : null;

  // janela 60d baseada na última data do período selecionado
  const maxDate = selMax || new Date();
  const winStart = new Date(maxDate.getTime() - 60*24*3600*1000);
  const inWin = dataFiltered.filter(x => x.data && x.data >= winStart && x.data <= maxDate);

  // KPIs
  const linhas = dataFiltered.length;
  const produtos = new Set(dataFiltered.map(x=>x.produto)).size;
  const rTotal60 = inWin.map(x=>x.rtot).filter(x=>x!=null).reduce((s,v)=>s+v,0);
  const kilos60 = inWin.map(x=>x.kilo).filter(x=>x!=null).reduce((s,v)=>s+v,0);

  const kiloMissing = inWin.length ? (inWin.filter(x=>x.kilo==null).length / inWin.length) : 0;

  document.getElementById("kpi_rows").textContent = fmtNum(linhas,0);
  document.getElementById("kpi_prod").textContent = fmtNum(produtos,0);
  document.getElementById("kpi_rtotal").textContent = rTotal60 ? fmtBRL(rTotal60) : "—";
  document.getElementById("kpi_kilo").textContent = kilos60 ? fmtNum(kilos60,0) : "—";
  document.getElementById("kpi_lastdate").textContent = selMax ? `até ${selMax.toLocaleDateString("pt-BR")}` : "—";
  document.getElementById("kpi_missing").textContent = inWin.length ? `KILO ausente: ${(kiloMissing*100).toFixed(1)}%` : "—";

  /* =========================
     1) ALERTAS DIF. R$ fora ±30%
  ========================= */
  const priceAlerts = inWin
    .filter(x => x.dif_r_pct != null && isFinite(x.dif_r_pct))
    .filter(x => Math.abs(x.dif_r_pct) >= 0.30)
    .map(x=>{
      const impacto = (x.kilo!=null && x.rkg!=null && x.base_r!=null)
        ? (x.rkg - x.base_r) * x.kilo
        : null;
      return {
        ...x,
        impacto,
        abs: Math.abs(x.dif_r_pct),
        rkg_num: (x.rkg!=null && isFinite(x.rkg)) ? x.rkg : null,
        base_num: (x.base_r!=null && isFinite(x.base_r)) ? x.base_r : null,
        dif_num: (x.dif_r_pct!=null && isFinite(x.dif_r_pct)) ? x.dif_r_pct : null,
        kilo_num: (x.kilo!=null && isFinite(x.kilo)) ? x.kilo : null,
        impacto_num: (impacto!=null && isFinite(impacto)) ? impacto : null,
        dataTS: x.data ? x.data.getTime() : null
      };
    });

  const baseMissingPct = priceAlerts.length
    ? (priceAlerts.filter(x=>x.base_r==null || !isFinite(x.base_r)).length / priceAlerts.length)
    : 0;

  const warnBase = (priceAlerts.length && baseMissingPct > 0.10)
    ? `<div class="warn small" style="margin:0 0 10px 0;">
         ATENÇÃO: Base R$ ausente em ${(baseMissingPct*100).toFixed(1)}% das linhas do relatório.
         Confira o card DEBUG (nomes das colunas no CSV).
       </div>`
    : "";

  if(priceAlerts.length){
    const cols = [
      { label:"Produto",        key:"produto" },
      { label:"Lote",           key:"lote" },
      { label:"Data",           key:"dataTS" },
      { label:"R$.KG",          key:"rkg_num" },
      { label:"Base R$",        key:"base_num" },
      { label:"DIF. R$",        key:"dif_num" },
      { label:"KILO",           key:"kilo_num" },
      { label:"Impacto (R$)",   key:"impacto_num" }
    ];

    // injeta aviso e tabela
    document.getElementById("tbl_price").innerHTML = warnBase + `<div id="tbl_price_inner"></div>`;

    renderSortableTable(
      "price",
      "tbl_price_inner",
      cols,
      priceAlerts,
      (x)=>[
        x.produto,
        x.lote || "",
        x.data ? x.data.toLocaleDateString("pt-BR") : "",
        fmtBRL(x.rkg),
        fmtBRL(x.base_r),
        fmtPctHTML(x.dif_r_pct,1),
        fmtNum(x.kilo,2),
        (x.impacto==null ? "—" : fmtBRL(x.impacto))
      ]
    );
  } else {
    document.getElementById("tbl_price").innerHTML =
      "<div class='muted small'>Nenhuma linha na janela (60 dias) com DIF. R$ fora de ±30%.</div>";
  }

  /* =========================
     2) Desvio NEC vs KILO
  ========================= */
  const kgdev=[];
  for(const r of inWin){
    if(r.nec==null || r.nec===0 || r.kilo==null) continue;
    const dev=(r.kilo-r.nec)/r.nec;
    kgdev.push({
      ...r,
      dev,
      abs: Math.abs(dev),
      dev_num: dev,
      abs_num: Math.abs(dev),
      nec_num: r.nec,
      kilo_num: r.kilo,
      dataTS: r.data ? r.data.getTime() : null
    });
  }

  if(kgdev.length){
    const cols = [
      { label:"Data",      key:"dataTS" },
      { label:"Produto",   key:"produto" },
      { label:"Fornecedor",key:"fornecedor" },
      { label:"NEC",       key:"nec_num" },
      { label:"KILO",      key:"kilo_num" },
      { label:"Desvio",    key:"dev_num" }
    ];

    renderSortableTable(
      "kgdev",
      "tbl_kgdev",
      cols,
      kgdev,
      (x)=>[
        x.data ? x.data.toLocaleDateString("pt-BR") : "",
        x.produto,
        x.fornecedor,
        fmtNum(x.nec,2),
        fmtNum(x.kilo,2),
        fmtPctHTML(x.dev,1)
      ]
    );
  } else {
    document.getElementById("tbl_kgdev").innerHTML =
      "<div class='muted small'>Sem dados suficientes (NEC e KILO) na janela de 60 dias.</div>";
  }

  /* =========================
     3) Dia anterior — DIF. R$ fora ±30%
  ========================= */
  const uniqueDates = Array.from(new Set(inWin.map(x=>x.dataISO).filter(Boolean))).sort();
  const yday = uniqueDates.length>1 ? uniqueDates[uniqueDates.length-2] : null;
  document.getElementById("kpi_prevdate").textContent = yday ? `dia ant.: ${new Date(yday).toLocaleDateString("pt-BR")}` : "dia ant.: —";

  let yRows=[];
  if(yday){
    yRows = inWin
      .filter(x=>x.dataISO===yday && x.dif_r_pct!=null && isFinite(x.dif_r_pct))
      .filter(x=>Math.abs(x.dif_r_pct)>=0.30)
      .map(x=>{
        const impacto = (x.kilo!=null && x.rkg!=null && x.base_r!=null)
          ? (x.rkg - x.base_r) * x.kilo
          : null;
        return {
          ...x,
          abs: Math.abs(x.dif_r_pct),
          dataTS: x.data ? x.data.getTime() : null,
          rkg_num: x.rkg,
          base_num: x.base_r,
          dif_num: x.dif_r_pct,
          impacto_num: impacto,
          kilo_num: x.kilo
        };
      });
  }

  if(yday){
    if(yRows.length){
      const cols = [
        { label:"Dia",        key:"dataTS" },
        { label:"Produto",    key:"produto" },
        { label:"Fornecedor", key:"fornecedor" },
        { label:"R$.KG",      key:"rkg_num" },
        { label:"Base R$",    key:"base_num" },
        { label:"DIF. R$",    key:"dif_num" },
        { label:"Lote",       key:"lote" }
      ];

      renderSortableTable(
        "prevday",
        "tbl_prevday",
        cols,
        yRows,
        (x)=>[
          x.data ? x.data.toLocaleDateString("pt-BR") : "",
          x.produto,
          x.fornecedor,
          fmtBRL(x.rkg),
          fmtBRL(x.base_r),
          fmtPctHTML(x.dif_r_pct,1),
          x.lote || ""
        ]
      );
    } else {
      document.getElementById("tbl_prevday").innerHTML =
        "<div class='muted small'>Nenhum item com DIF. R$ fora de ±30% no “dia anterior”.</div>";
    }
  } else {
    document.getElementById("tbl_prevday").innerHTML =
      "<div class='muted small'>Sem histórico suficiente para identificar “dia anterior”.</div>";
  }

  /* =========================
     4) Curva ABC por KILO
  ========================= */
  const kiloByProd=new Map();
  for(const r of inWin){
    if(r.kilo==null) continue;
    kiloByProd.set(r.produto,(kiloByProd.get(r.produto)||0)+r.kilo);
  }
  const abc=Array.from(kiloByProd.entries()).map(([produto,kilo])=>({produto,kilo, kilo_num:kilo}));
  abc.sort((a,b)=>b.kilo-a.kilo);
  const totalK = abc.reduce((s,x)=>s+x.kilo,0) || 1;

  let acc=0;
  const abcRows = abc.map(x=>{
    acc += x.kilo;
    const accPct=acc/totalK;
    const cls = accPct<=0.8 ? "A" : (accPct<=0.95 ? "B" : "C");
    return {
      ...x,
      accPct,
      cls,
      acc_num: accPct
    };
  });

  if(abcRows.length){
    const cols = [
      { label:"Produto",  key:"produto" },
      { label:"KILO (60d)", key:"kilo_num" },
      { label:"% acum.",  key:"acc_num" },
      { label:"Classe",   key:"cls" }
    ];

    renderSortableTable(
      "abc",
      "tbl_abc",
      cols,
      abcRows,
      (x)=>[
        x.produto,
        fmtNum(x.kilo,0),
        fmtPctHTML(x.accPct,1),
        x.cls
      ]
    );
  } else {
    document.getElementById("tbl_abc").innerHTML =
      "<div class='muted small'>Sem KILO suficiente na janela de 60 dias.</div>";
  }

  /* =========================
     5) Pendências NF REC
  ========================= */
  const bad=new Set(["ATUAL","NRC","REC.","REC"]);
  const pend=inWin.filter(x=>{
    const q=(x.qld||"").trim().toUpperCase();
    return (!x.nf) && q && !bad.has(q);
  }).map(x=>({
    ...x,
    dataTS: x.data ? x.data.getTime() : null
  }));

  if(pend.length){
    const cols = [
      { label:"Data",      key:"dataTS" },
      { label:"Produto",   key:"produto" },
      { label:"Fornecedor",key:"fornecedor" },
      { label:"QLD.",      key:"qld" },
      { label:"NF REC.",   key:"nf" }
    ];

    renderSortableTable(
      "nf",
      "tbl_nf",
      cols,
      pend,
      (x)=>[
        x.data ? x.data.toLocaleDateString("pt-BR") : "",
        x.produto,
        x.fornecedor,
        x.qld||"",
        x.nf||""
      ]
    );
  } else {
    document.getElementById("tbl_nf").innerHTML =
      "<div class='muted small'>Sem pendências de NF REC (com QLD válido) na janela de 60 dias.</div>";
  }

  const rangeTxt = selMin && selMax
    ? `Período: ${selMin.toLocaleDateString("pt-BR")} → ${selMax.toLocaleDateString("pt-BR")}`
    : "Período: —";

  document.getElementById("meta").textContent =
    `OK — ${fmtNum(linhas,0)} linhas (período selecionado). ${rangeTxt}. ` +
    `Janela 60d: ${winStart.toLocaleDateString("pt-BR")} → ${maxDate.toLocaleDateString("pt-BR")}.`;
}

// Se quiser carregar automaticamente ao abrir, descomente:
// window.addEventListener("load", loadData);
</script>

</body>
</html>
